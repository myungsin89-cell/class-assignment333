# 학급 편성 시스템 개선 계획서

## 📋 현재 구현 상태 분석

### ✅ 이미 구현된 기능

1. **데이터베이스 구조 (SQLite)**
   - schools, classes, students 테이블
   - 학교 단위 로그인/인증 시스템
   - 학생 필드: 이름, 성별, 문제아, 특수반, 그룹(1-10), 석차, 이전반

2. **데이터 입력 기능**
   - ✅ 엑셀 Ctrl+V 붙여넣기 지원
   - ✅ 개별 필드 붙여넣기 지원
   - ✅ 웹 그리드 직접 편집
   - ✅ 템플릿 다운로드

3. **반편성 알고리즘**
   - ✅ 성별 분리 배치
   - ✅ 석차 기반 Serpentine(왕복) 배치
   - ✅ 그룹 분리 (같은 그룹은 다른 반에 배치)
   - ✅ 동명이인 분리
   - ✅ 특수반 학생 균등 배치

4. **UI/UX**
   - ✅ 한국어 기반 인터페이스
   - ✅ 기존반/새로운반 구분 표시
   - ✅ 반별 네비게이션 사이드바
   - ✅ 이전 반 번호 표시

---

## ❌ 부족한 기능 및 개선 필요 사항

### 1. PWA (Progressive Web App) 구현 ⭐ 최우선
**목적:** 여러 학교 동시 사용 시 서버 부하 최소화, 오프라인 작업 지원

**구현 항목:**
- [ ] `manifest.json` 생성 (앱 이름, 아이콘, 색상 테마)
- [ ] Service Worker 구현
  - 정적 리소스 캐싱 (HTML, CSS, JS)
  - API 응답 캐싱 전략 (Network First for login, Cache First for static)
  - 오프라인 페이지 제공
- [ ] 로컬 스토리지 활용 확대
  - 학생 데이터 로컬 캐싱
  - 오프라인 모드에서도 편성 시뮬레이션 가능
  - 온라인 복귀 시 자동 동기화
- [ ] 앱 설치 프롬프트 (Add to Home Screen)

---

### 2. 석차 지정 모달 (Drag & Drop) ⭐ 핵심 UX
**현재 상태:** 테이블에서 숫자 직접 입력만 가능
**개선 필요:** 직관적인 드래그 앤 드롭 인터페이스

**구현 항목:**
- [ ] 석차 지정 전용 모달 페이지
  - 메인 화면에 [학생 석차 지정] 버튼 추가
- [ ] 남학생/여학생 영역 분리
  - 좌측: 남학생 석차 영역 (1등, 2등, 3등... 박스)
  - 우측: 여학생 석차 영역 (1등, 2등, 3등... 박스)
- [ ] 미지정 학생 풀 (Pool)
  - 상단에 석차 미지정 학생 카드 목록
  - 드래그하여 순번 박스에 배치
- [ ] 드래그 앤 드롭 라이브러리 적용
  - `@dnd-kit/core` 또는 `react-beautiful-dnd`
- [ ] 자동 저장 또는 [적용] 버튼으로 rank 필드 업데이트

**UI 스케치:**
```
┌─────────────────────────────────────────────────────────┐
│  📊 학생 석차 지정                               [닫기] │
├─────────────────────────────────────────────────────────┤
│  미지정 학생 (드래그하여 순번에 배치하세요)           │
│  [홍길동] [이철수] [박민수] ...                        │
├──────────────────────────┬──────────────────────────────┤
│ 👦 남학생 석차           │ 👧 여학생 석차               │
├──────────────────────────┼──────────────────────────────┤
│ 1등: [드롭 영역]         │ 1등: [드롭 영역]             │
│ 2등: [드롭 영역]         │ 2등: [드롭 영역]             │
│ 3등: [홍길동]            │ 3등: [김영희]                │
│ ...                      │ ...                          │
└──────────────────────────┴──────────────────────────────┘
```

---

### 3. 분리 조건 전용 패널 ⭐ 핵심 기능
**현재 상태:** 드롭다운에서 그룹1~10 선택만 가능
**개선 필요:** 시각적으로 분리 대상 그룹을 관리하는 전용 UI

**구현 항목:**
- [ ] [분리 대상 설정] 전용 패널/모달
  - 학생 목록에서 여러 명 선택
  - "그룹 추가" 버튼으로 새 분리 그룹 생성
  - 그룹별로 카드 형태로 표시
- [ ] 🔗분리 태그 시각화
  - 그룹에 속한 학생에게 아이콘 또는 배지 표시
  - 테이블에서 한눈에 구분 가능
- [ ] 그룹 관리 기능
  - 그룹명 편집 (그룹1, 그룹2... → 사용자 정의 이름 가능)
  - 학생 추가/제거
  - 그룹 삭제

**UI 스케치:**
```
┌─────────────────────────────────────────────────┐
│  🔗 분리 대상 설정                       [닫기] │
├─────────────────────────────────────────────────┤
│  그룹 1: 친구 그룹 A                   [✏️][🗑️] │
│    - 홍길동                                     │
│    - 이철수                                     │
│                                                 │
│  그룹 2: 친구 그룹 B                   [✏️][🗑️] │
│    - 김영희                                     │
│    - 박수진                                     │
│                                                 │
│  [+ 새 그룹 추가]                               │
└─────────────────────────────────────────────────┘
```

---

### 4. 반편성 알고리즘 개선 (4단계 우선순위)
**현재 상태:** 기본 로직은 구현되어 있으나 우선순위 명확성 부족

**개선 항목:**
- [ ] 🥇 최우선: 분리 필수 학생 배치
  - ✅ 이미 구현됨 (group_name 충돌 체크)
  - ⚠️ 검증: 100% 보장되는지 테스트 필요

- [ ] 🥈 2순위: 원래 반 쏠림 방지
  - ⚠️ 현재: previous_section 저장만 되고, 쏠림 방지 로직은 약함
  - **개선 필요:**
    - 각 기존 반 출신 학생들을 새 반에 최대한 균등 분산
    - 예: 1반 30명 → 새로운 1반 10명, 2반 10명, 3반 10명
    - 알고리즘: Round-robin 방식으로 기존 반 출신을 순환 배치

- [ ] 🥉 3순위: 성적 균등 (석차 기반)
  - ✅ 이미 구현됨 (Serpentine 지그재그 배치)

- [ ] 4순위: 특이 학생 균형
  - ✅ 이미 구현됨 (문제아, 특수반 균등 분배)

**알고리즘 수정 계획:**
```javascript
// 개선된 배치 순서
1. 모든 학생을 기존 반별로 그룹핑
2. 각 기존 반마다:
   - 성별로 분리
   - 석차순 정렬
   - Serpentine 배치 (단, 시작 오프셋을 기존 반 번호로 차등 적용)
3. 그룹 충돌 체크 및 재배치
4. 통계 검증 (쏠림, 성적 분포, 특이 학생)
```

---

### 5. 검증 보고서 및 통계 ⭐ 신뢰성 증명
**현재 상태:** 간단한 alert 메시지만 표시
**개선 필요:** 상세한 검증 보고서 페이지

**구현 항목:**
- [ ] 반편성 완료 후 검증 리포트 페이지 자동 표시
- [ ] 📊 분리 성공률
  - 전체 그룹 수 대비 성공/실패 개수
  - ✅ 성공 / ❌ 실패 표시
  - 실패한 그룹 목록 (경고)
- [ ] 📊 원래 반 쏠림 현황
  - 막대 그래프 또는 히트맵
  - 예: 기존 1반 → 새로운 1반 12명, 2반 8명, 3반 10명
- [ ] 📊 성적 균등도
  - 각 반의 평균 석차
  - 표준편차 계산 및 표시
  - 목표: 모든 반의 평균 석차가 비슷하게
- [ ] 📊 특이 학생 분포
  - 각 반의 문제아/특수반 학생 수
  - 목표: 최대한 균등 분배

**UI 스케치:**
```
┌─────────────────────────────────────────────────┐
│  📊 반편성 검증 리포트                          │
├─────────────────────────────────────────────────┤
│  ✅ 분리 조건: 10개 그룹 중 10개 성공 (100%)   │
│                                                 │
│  📊 원래 반 쏠림 현황                           │
│  [막대 그래프]                                  │
│                                                 │
│  📊 성적 균등도                                 │
│  1반 평균: 15.2 | 2반 평균: 15.8 | 3반: 14.9   │
│  표준편차: 0.45 (✅ 우수)                       │
│                                                 │
│  📊 특이 학생 분포                              │
│  1반: 문제아 2명, 특수반 1명                    │
│  2반: 문제아 2명, 특수반 1명                    │
│  3반: 문제아 2명, 특수반 1명                    │
└─────────────────────────────────────────────────┘
```

---

### 6. 최종 조정 기능 (Drag & Drop) ⭐ UX 개선
**현재 상태:** 편성 후 수정은 직접 DB 조작만 가능
**개선 필요:** 결과 화면에서 직접 학생 이동

**구현 항목:**
- [ ] 반편성 결과 화면에서 학생 카드 드래그 앤 드롭
  - 학생 카드를 다른 반으로 드래그하여 이동
- [ ] 분리 조건 위배 시 경고
  - 같은 그룹 학생이 있는 반으로 이동 시 팝업 경고
  - "정말로 이동하시겠습니까? (분리 조건 위배)" 확인
- [ ] 실시간 통계 업데이트
  - 학생 이동 시 각 반의 성별, 문제아, 특수반 숫자 자동 갱신
- [ ] [조정 저장] 버튼으로 최종 확정

---

### 7. 추가 필드 구현
**현재 부족한 필드:**
- [ ] 생년월일 (birth_date)
- [ ] 보호자 연락처 (parent_contact)
- [ ] 현재 학급 (current_class) - 작년 학급 추적용
  - ⚠️ 현재 previous_section은 반편성 후 이전 반이므로 용도가 다름

**DB 스키마 추가:**
```sql
ALTER TABLE students ADD COLUMN birth_date TEXT;
ALTER TABLE students ADD COLUMN parent_contact TEXT;
ALTER TABLE students ADD COLUMN current_class TEXT;
```

---

## 📅 구현 우선순위

### Phase 1: 핵심 UX 개선 (2주)
1. 석차 지정 모달 (Drag & Drop)
2. 분리 조건 전용 패널
3. 🔗분리 태그 시각화

### Phase 2: 알고리즘 개선 (1주)
1. 원래 반 쏠림 방지 로직 강화
2. 4단계 우선순위 명확화

### Phase 3: 검증 및 조정 (1주)
1. 검증 보고서 페이지
2. 통계 그래프 (Chart.js 또는 Recharts)
3. 수동 조정 Drag & Drop

### Phase 4: PWA 및 최적화 (1주)
1. manifest.json 및 Service Worker
2. 로컬 캐싱 전략
3. 오프라인 모드

### Phase 5: 추가 기능 (선택)
1. 추가 필드 구현 (생년월일, 연락처)
2. 엑셀 다운로드 기능
3. 인쇄용 명렬표 출력

---

## 🛠️ 기술 스택 추가 제안

### 현재 사용 중
- Next.js 16 (App Router)
- React 19
- SQLite (better-sqlite3)
- TypeScript
- Tailwind CSS (v4)

### 추가 필요
- **Drag & Drop:** `@dnd-kit/core` (현대적이고 접근성 좋음)
- **차트:** `recharts` 또는 `chart.js`
- **PWA:** `next-pwa` (Next.js PWA 플러그인)
- **상태 관리 (선택):** Zustand (로컬 캐싱 동기화용)

---

## 📝 다음 단계

1. ✅ 현재 구현 분석 완료
2. [ ] Phase 1 착수: 석차 지정 모달 설계 및 구현
3. [ ] 분리 조건 패널 UI 구현
4. [ ] 알고리즘 개선 및 테스트
5. [ ] 검증 리포트 구현
6. [ ] PWA 적용

---

## 💡 주요 개선 포인트 요약

| 항목 | 현재 상태 | 목표 상태 |
|------|----------|----------|
| 석차 입력 | 숫자 직접 입력 | 드래그 앤 드롭 모달 |
| 분리 조건 | 드롭다운 선택 | 전용 패널 + 태그 시각화 |
| 쏠림 방지 | 약함 | 명시적 알고리즘 |
| 검증 | 간단한 alert | 상세 리포트 + 그래프 |
| 조정 | 불가능 | Drag & Drop 수정 |
| PWA | 미구현 | 오프라인 작업 지원 |

---

**작성일:** 2025-12-07
**버전:** 1.0
